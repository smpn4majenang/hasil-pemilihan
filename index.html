<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Count E-Voting - SMPN 4 Majenang</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Real Count Hasil Suara</h1>
                    <p class="text-xs text-gray-500">Pemilihan OSIS & DP - SMPN 4 Majenang</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <span id="last-update" class="text-xs font-medium text-gray-500 hidden sm:inline">Belum Update</span>
                <button onclick="fetchData()" class="text-sm bg-indigo-100 text-indigo-600 px-4 py-2 rounded-lg hover:bg-indigo-200 transition font-medium">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">

        <!-- KARTU RINGKASAN TOTAL -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <!-- Total Suara OSIS -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 border-l-4 border-blue-500">
                <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Suara Masuk (OSIS)</h3>
                <div class="flex items-baseline mt-2">
                    <span id="total-osis" class="text-3xl font-bold text-gray-800">0</span>
                    <span class="ml-2 text-sm text-gray-400">Suara</span>
                </div>
            </div>
            <!-- Total Suara DP Putra -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 border-l-4 border-green-500">
                <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Suara Masuk (DP Putra)</h3>
                <div class="flex items-baseline mt-2">
                    <span id="total-pa" class="text-3xl font-bold text-gray-800">0</span>
                    <span class="ml-2 text-sm text-gray-400">Suara</span>
                </div>
            </div>
            <!-- Total Suara DP Putri -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 border-l-4 border-pink-500">
                <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider">Suara Masuk (DP Putri)</h3>
                <div class="flex items-baseline mt-2">
                    <span id="total-pi" class="text-3xl font-bold text-gray-800">0</span>
                    <span class="ml-2 text-sm text-gray-400">Suara</span>
                </div>
            </div>
        </div>

        <!-- GRAFIK 1: KETUA OSIS -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">1. Perolehan Suara Ketua OSIS</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 relative h-[300px]">
                    <canvas id="chartOsis"></canvas>
                </div>
                <div class="space-y-4">
                    <!-- Detail Kandidat 1 -->
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-blue-800 text-sm">01. Dika dan Kamelia</span>
                            <span id="val-osis-1" class="font-bold text-blue-600 text-lg">0</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            <div id="bar-osis-1" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- Detail Kandidat 2 -->
                    <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-indigo-800 text-sm">02. Aurel dan Sidik</span>
                            <span id="val-osis-2" class="font-bold text-indigo-600 text-lg">0</span>
                        </div>
                        <div class="w-full bg-indigo-200 rounded-full h-2">
                            <div id="bar-osis-2" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- GRAFIK 2: DP PUTRA -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">2. Ketua DP Putra</h2>
                <div class="relative h-[250px]">
                    <canvas id="chartDpPa"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <p class="text-xs text-gray-500 font-bold">Galih Priyadi</p>
                        <p id="val-pa-1" class="text-xl font-bold text-green-600">0</p>
                    </div>
                    <div class="text-center p-3 bg-teal-50 rounded-lg">
                        <p class="text-xs text-gray-500 font-bold">Gian Aditya</p>
                        <p id="val-pa-2" class="text-xl font-bold text-teal-600">0</p>
                    </div>
                </div>
            </div>

            <!-- GRAFIK 3: DP PUTRI -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">3. Ketua DP Putri</h2>
                <div class="relative h-[250px]">
                    <canvas id="chartDpPi"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-pink-50 rounded-lg">
                        <p class="text-xs text-gray-500 font-bold">Denaya Septiani</p>
                        <p id="val-pi-1" class="text-xl font-bold text-pink-600">0</p>
                    </div>
                    <div class="text-center p-3 bg-rose-50 rounded-lg">
                        <p class="text-xs text-gray-500 font-bold">Saikoh Nur Azizah</p>
                        <p id="val-pi-2" class="text-xl font-bold text-rose-600">0</p>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <script>
        // === KONFIGURASI ===
        const USE_GOOGLE_SHEET = true; 
        // Masukkan URL Web App Script yang SAMA dengan aplikasi voting
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxrrDcdrGmRyFzRiI5gF5k11cbzuEeK5PFj4jOEp0AsXZmyscyM_ezROs1M4RyFu_e5/exec"; 

        // --- INISIALISASI CHART ---
        
        // 1. Chart OSIS
        const ctxOsis = document.getElementById('chartOsis').getContext('2d');
        const chartOsis = new Chart(ctxOsis, {
            type: 'bar',
            data: {
                labels: ['01. Dika dan Kamelia', '02. Aureldan Sidik'],
                datasets: [{
                    label: 'Suara',
                    data: [0, 0],
                    backgroundColor: ['#3B82F6', '#6366F1'],
                    borderRadius: 8,
                    barThickness: 50
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { beginAtZero: true } } }
        });

        // 2. Chart DP Putra
        const ctxPa = document.getElementById('chartDpPa').getContext('2d');
        const chartPa = new Chart(ctxPa, {
            type: 'doughnut',
            data: {
                labels: ['Galih Priyadi', 'Gian Aditya'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#10B981', '#14B8A6'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 3. Chart DP Putri
        const ctxPi = document.getElementById('chartDpPi').getContext('2d');
        const chartPi = new Chart(ctxPi, {
            type: 'doughnut',
            data: {
                labels: ['Denaya Septiani', 'Saikoh Nur Azizah'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#EC4899', '#F43F5E'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // --- FUNGSI AMBIL DATA ---
        async function fetchData() {
            const statusEl = document.getElementById('last-update');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                let data;
                if (USE_GOOGLE_SHEET) {
                    // Panggil Script dengan action=getResults
                    const response = await fetch(`${GAS_URL}?action=getResults`);
                    data = await response.json();
                } else {
                    // Mock Data Offline
                    await new Promise(r => setTimeout(r, 1000));
                    data = {
                        osis: { "Paslon 01 (Dika dan Kamelia)": 150, "Paslon 02 (Aurel dan Sidik)": 120 },
                        dp_pa: { "Galih Priyadi (No. 1)": 80, "Gian Aditya (No. 2)": 90 },
                        dp_pi: { "Denaya Septiani (No. 1)": 100, "Saikoh Nur Azizah (No. 2)": 110 }
                    };
                }
                updateCharts(data);
                
                const now = new Date();
                statusEl.textContent = 'Update: ' + now.toLocaleTimeString();

            } catch (error) {
                console.error(error);
                statusEl.textContent = "Gagal mengambil data";
            }
        }

        function updateCharts(data) {
            // --- 1. UPDATE OSIS ---
            // Sesuaikan "key" dengan string yang dikirim dari file voting
            const osis1 = data.osis["Paslon 01 (Dika dan Kamelia)"] || 0;
            const osis2 = data.osis["Paslon 02 (Aurel dan Sidik)"] || 0;
            const totalOsis = osis1 + osis2;

            chartOsis.data.datasets[0].data = [osis1, osis2];
            chartOsis.update();
            
            document.getElementById('total-osis').textContent = totalOsis;
            document.getElementById('val-osis-1').textContent = osis1;
            document.getElementById('val-osis-2').textContent = osis2;
            
            // Update Progress Bar
            document.getElementById('bar-osis-1').style.width = totalOsis ? (osis1/totalOsis*100) + '%' : '0%';
            document.getElementById('bar-osis-2').style.width = totalOsis ? (osis2/totalOsis*100) + '%' : '0%';

            // --- 2. UPDATE DP PUTRA ---
            const pa1 = data.dp_pa["Galih Priyadi (No. 1)"] || 0;
            const pa2 = data.dp_pa["Gian Aditya (No. 2)"] || 0;
            
            chartPa.data.datasets[0].data = [pa1, pa2];
            chartPa.update();
            document.getElementById('total-pa').textContent = pa1 + pa2;
            document.getElementById('val-pa-1').textContent = pa1;
            document.getElementById('val-pa-2').textContent = pa2;

            // --- 3. UPDATE DP PUTRI ---
            const pi1 = data.dp_pi["Denaya Septiani (No. 1)"] || 0;
            const pi2 = data.dp_pi["Saikoh Nur Azizah (No. 2)"] || 0;

            chartPi.data.datasets[0].data = [pi1, pi2];
            chartPi.update();
            document.getElementById('total-pi').textContent = pi1 + pi2;
            document.getElementById('val-pi-1').textContent = pi1;
            document.getElementById('val-pi-2').textContent = pi2;
        }

        // Auto Refresh
        fetchData();
        setInterval(fetchData, 15000); // Update tiap 15 detik

    </script>
</body>
</html>
